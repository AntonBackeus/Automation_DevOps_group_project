name: Generate and Push Docker Image Application

on:
  schedule:
  - cron: 0 3 * * *
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  run-dlt:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run dlt pipeline
        run: |
          python extract_load/load_jobs.py > dlt_error.log 2>&1
    
      - name: Upload dlt error log
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: dlt-error-log
          path: dlt_error.log

      - name: Upload DuckDB database as artifact
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: duckdb-database-dlt
          path: ./data_warehouse/job_ads.duckdb
          
  run-dbt:
    needs: run-dlt
    runs-on: ubuntu-latest
    env:
      DBT_PROFILES_DIR: ../.dbt

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Download DuckDB database artifact
        uses: actions/download-artifact@v4
        with:
          name: duckdb-database-dlt
          path: ./data_warehouse 
        
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
        
      - name: Install dbt
        run: |
          pip install dbt-core dbt-duckdb

      - name: Run dbt models
        working-directory: ./dbt_analytics
        run: |
          dbt run > dbt_run_error.log 2>&1

      - name: Run dbt tests
        working-directory: ./dbt_analytics
        run: |
          dbt test > dbt_test_error.log 2>&1

      - name: Upload dbt logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: dbt-error-logs
          path: ./dbt_analytics/*.log


      - name: Upload DuckDB database as artifact
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: duckdb-database-dbt
          path: ./data_warehouse/job_ads.duckdb

  validate-db:
    needs: run-dbt
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download DuckDB database artifact
        uses: actions/download-artifact@v4
        with:
          name: duckdb-database-dbt
          path: ./data_warehouse

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run DuckDB validation
        id: validate_db
        run: python validation/duckdb_validation.py > duckdb_validation.log 2>&1

      - name: Upload DuckDB validation logs
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: duckdb-validation-error-logs
          path: duckdb_validation.log

build-and-push:
  needs: validate-db
  runs-on: ubuntu-latest

  steps:
    - name: Check repository
      uses: actions/checkout@v4

    - name: Download DuckDB database artifact
      uses: actions/download-artifact@v4
      with:
        name: duckdb-database-dbt
        path: ./data_warehouse

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Log in to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}

    - name: Build Docker image
      id: docker_build
      run: |
        docker build \
          -t antonbackeus/hranalyticsdashboard:latest \
          -t antonbackeus/hranalyticsdashboard:1.${{ github.run_number }} \
          . > docker_build.log 2>&1

    - name: Test Docker image
      id: docker_test
      run: |
        docker run -d -p 8501:8501 --name test_app antonbackeus/hranalyticsdashboard:latest
        for i in {1..10}; do
          echo "Checking if Streamlit server is up (attempt $i)..."
          if curl --fail http://localhost:8501 2>/dev/null; then
            echo "Streamlit server is running!"
            break
          fi
          sleep 3
        done
        if ! curl --fail http://localhost:8501 2>/dev/null; then
          echo "ERROR: Streamlit app did not start correctly"
          docker logs test_app > docker_test_error.log 2>&1
          docker stop test_app
          exit 1
        fi
        docker stop test_app

    - name: Push Docker image
      if: success()
      uses: docker/build-push-action@v6
      with:
        context: .
        file: ./Dockerfile
        push: true
        tags: |
          antonbackeus/hranalyticsdashboard:latest
          antonbackeus/hranalyticsdashboard:1.${{ github.run_number }}

    - name: Upload Docker build logs
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: docker-build-error-logs
        path: docker_build.log

    - name: Upload Docker test logs
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: docker-test-error-logs
        path: docker_test_error.log
